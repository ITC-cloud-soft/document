<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>ADF&#x3067;&#x30c7;&#x30fc;&#x30bf;&#x7d71;&#x5408;</title>
        <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
        
    </head>
    <body class="vscode-body vscode-light">
        <h1 id="adfでデータ統合">ADFでデータ統合</h1>
<h2 id="概要">概要</h2>
<p>データベースがAzure SQL DatabaseからTiDBに変更される過程で、データ移行に関する課題が発生すると想定しています。本書では、Azure Data Factory（ADF）を使用してデータ移行の問題を解決する方法について検討します。</p>
<p>※ TiDBのデータエンジンはMySQLと類似しているため、本書で言及されているMySQLの記述はTiDBと同等と見なすことができます。</p>
<h2 id="統合ランタイムの選択">統合ランタイムの選択</h2>
<p>参照資料：<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/copy-activity-overview#supported-data-stores-and-formats">サポートされるデータ ストアと形式</a></p>
<h3 id="tidbの利用可能な統合ランタイムの確認">TiDBの利用可能な統合ランタイムの確認</h3>
<p><img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\datasource_header.png" alt="Alt text">
<img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\datasource_azure_sql.png" alt="Alt text">
<img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\datasource_onpremis_mysql.png" alt="Alt text">
<img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\datasource_onpremis_odbc.png" alt="Alt text"></p>
<p>Azure SQL DatabaseからTiDBにデータを移行することが目的です。ただし、上記の表からわかるように、データストア「MySQL」はシンクとしてサポートされていません。そのため、ADFでTiDBのLinkServiceを作成する際、MySQLコネクタを使用することはできません。さらに、ADFは現在TiDBをサポートしていないため、一般的なコネクタ「汎用ODBC」を使用するしかありません。
そのため、統合ランタイムにセルフホステッドIR(SHIR)を選択することにします。</p>
<h2 id="セルフホステッドirの用意">セルフホステッドIRの用意</h2>
<p>参照資料：<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/create-self-hosted-integration-runtime?tabs=data-factory">セルフホステッド統合ランタイムを作成して構成する</a></p>
<p>※ TiDBへの接続はVisualC++の再配布可能パッケージ及びMySQLコネクターのインストールが必要です。(
<a href="https://dev.mysql.com/doc/connector-odbc/en/connector-odbc-installation-binary-windows.html">Installing MySQL Connector/ODBC on Windows</a>)</p>
<h3 id="コピーするデータ-フロー手順の概要">コピーするデータ フロー手順の概要</h3>
<p><img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\shir_ach.png" alt="Alt text"></p>
<h3 id="ポートとファイアウォール">ポートとファイアウォール</h3>
<p>考慮すべきファイアウォールが 2 つあります。</p>
<ul>
<li>組織の中央ルーターで実行されている &quot;企業ファイアウォール&quot;</li>
<li>セルフホステッド統合ランタイムがインストールされているローカル コンピューターでデーモンとして実行されている &quot;Windows ファイアウォール&quot;</li>
</ul>
<p><img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\firewall.png" alt="Alt text"></p>
<p>企業ファイアウォール レベルでは、次のドメインと送信ポートを構成する必要があります。</p>
<p><img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\firewall_domain.png" alt="Alt text"></p>
<p>※ <strong>*.servicebus.windows.net</strong>を許可せずに、より具体的な URL を使用する必要がある場合は、セルフホステッド統合ランタイムに必要なすべての FQDN をサービス ポータルから確認できます。 次の手順のようにします。</p>
<p><img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\firewall_services_url.png" alt="Alt text"></p>
<p>Windows ファイアウォール レベル (コンピューター レベル) では、通常、これらの送信ポートが有効になっています。 有効になっていない場合は、セルフホステッド統合ランタイム コンピューターで、ドメインとポートを構成することができます。</p>
<p>※ お使いのソースやシンクに基づいて、追加のドメインと送信ポートを企業ファイアウォールまたは Windows ファイアウォールで許可しなければならない場合があります。</p>
<h2 id="セルフホステッド統合ランタイムを作成して構成する">セルフホステッド統合ランタイムを作成して構成する</h2>
<h3 id="前提条件">前提条件</h3>
<ul>
<li>セルフホステッド統合ランタイムには、.NET Framework 4.7.2 以降を含む 64 ビット オペレーティング システムが必要です</li>
<li>オペレーティング システムからソースデータストアとシンクデータストアと両方へ通信できます</li>
<li>セルフホステッド統合ランタイム コンピューターに推奨される最小構成は、4 コアの 2 GHz プロセッサ、8 GB の RAM、および 80 GB の使用可能なハード ドライブ領域です</li>
<li>サポートされている Windows のバージョンは次のとおりです
<ul>
<li>Windows 8.1</li>
<li>Windows 10</li>
<li>Windows 11</li>
<li>Windows Server 2012</li>
<li>Windows Server 2012 R2</li>
<li>Windows Server 2016</li>
<li>Windows Server 2019</li>
<li>Windows Server 2022</li>
</ul>
</li>
</ul>
<h3 id="セットアップ">セットアップ</h3>
<p>具体的な設定手順は右記の公式サイトをご参照ください。 (<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/create-self-hosted-integration-runtime?tabs=data-factory#setting-up-a-self-hosted-integration-runtime">セットアップ手順</a>)</p>
<h2 id="セルフホステッド統合ランタイムのインストールの自動化">セルフホステッド統合ランタイムのインストールの自動化</h2>
<p>参照資料：<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/self-hosted-integration-runtime-automation-scripts">ローカル PowerShell スクリプトを使用したセルフホステッド統合ランタイムのインストールの自動化</a></p>
<h3 id="前提条件-1">前提条件</h3>
<ul>
<li>ローカル コンピューターで PowerShell を起動します。 スクリプトを実行するには、[<strong>管理者として実行</strong>] を選択する必要があります。</li>
<li>セルフホステッド統合ランタイム ソフトウェアを<a href="https://www.microsoft.com/ja-jp/download/details.aspx?id=39717">ダウンロード</a>します。 ダウンロードしたファイルのパスをコピーします。</li>
<li>セルフホステッド統合ランタイムを登録するには<strong>認証キー</strong>も必要です。</li>
<li>手動更新を自動化するには、事前に構成されたセルフホステッド統合ランタイムが必要です。</li>
</ul>
<h3 id="使用例">使用例</h3>
<p>1.上記のダウンロードされた SHIR MSI (インストール ファイル) のパスを指定します。 たとえば、パスが C:\Users\username\Downloads\IntegrationRuntime_4.7.7368.1.msi の場合、次の PowerShell コマンドライン例をこのタスクに使用できます。</p>
<pre><code class="language-PowerShell"><span class="hljs-built_in">PS</span> C:\windows\system32&gt; C:\Users\username\Desktop\InstallGatewayOnLocalMachine.ps1 <span class="hljs-literal">-path</span> <span class="hljs-string">&quot;C:\Users\username\Downloads\IntegrationRuntime_4.7.7368.1.msi&quot;</span> <span class="hljs-literal">-authKey</span> <span class="hljs-string">&quot;[key]&quot;</span>
</code></pre>
<p>2.インストールとキーの登録が完了すると、&quot;Succeed to install gateway(ゲートウェイのインストールに成功) &quot; と &quot;Succeed to register gateway(ゲートウェイの登録に成功) &quot; の結果が、ローカルの PowerShell に表示されます。</p>
<p><img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\script-1-run-result.png" alt="Alt text"></p>
<h2 id="セルフホステッド統合ランタイムのコンテナー化">セルフホステッド統合ランタイムのコンテナー化</h2>
<p>参照資料：<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/how-to-run-self-hosted-integration-runtime-in-windows-container">Windows コンテナーでセルフホステッド統合ランタイムを実行する方法
</a></p>
<h2 id="コピー-アクティビティのパフォーマンス">コピー アクティビティのパフォーマンス</h2>
<p>参照資料：<a href="https://learn.microsoft.com/ja-jp/azure/data-factory/copy-activity-performance">コピー アクティビティのパフォーマンスとスケーラビリティに関するガイド</a></p>
<h3 id="セルフホステッド統合ランタイムのスケーラビリティ">セルフホステッド統合ランタイムのスケーラビリティ</h3>
<p>より高いスループットを実現するには、セルフホステッド IR をスケールアップするかスケールアウトします。</p>
<ul>
<li>セルフホステッド IR ノード上の CPU と使用可能なメモリが十分に活用されていないにもかかわらず、同時ジョブの実行が上限に達する場合は、ノードで実行できる同時実行ジョブの数を増やすことでスケールアップを行う必要があります。 手順については、次の手順を参照してください。</li>
</ul>
<pre><code class="language-Text">プロセッサと使用可能な RAM はあまり使用されていないが、同時実行ジョブの実行がノードの制限に達した場合は、1 つのノードが実行できる同時実行ジョブの数を増やしてスケールアップします。 また、セルフホステッド IR が過負荷になっているために、アクティビティがタイムアウトになる場合も、スケールアップが必要になることがあります。 次の画像に示すように、ノードの最大容量を増やすことができます。
</code></pre>
<p><img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\scale-up-self-hosted-ir.png" alt="Alt text"></p>
<ul>
<li>一方、セルフホステッド IR ノードの CPU が高いか、使用可能なメモリが少ない場合は、新しいノードを追加して、複数のノード間で負荷をスケールアウトすることができます。</li>
</ul>
<h3 id="並列コピー">並列コピー</h3>
<p>Copy アクティビティで並列コピー (Copy アクティビティの JSON 定義の parallelCopies プロパティ、またはユーザー インターフェイスの Copy アクティビティのプロパティの [設定] タブにある Degree of parallelism 設定) を設定し、使用する並列処理を指示できます。 このプロパティは、並列でソースから読み取る、またはシンク データ ストアに書き込むコピー アクティビティ内の最大スレッド数と見なすことができます。</p>
<p><img src="file:///c:\Users\baofe\aeon_work\03_成果物\03_调查\01_ADF\01_manual\images\parallelism.png" alt="Alt text"></p>
<style>
p:has(> img){
    display: grid;
}
</style>

        
        
    </body>
    </html>